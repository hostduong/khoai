{% set title = "ÄÄƒng kÃ½ tÃ i khoáº£n | Gem.id.vn - Há»‡ thá»‘ng Email Tá»± Äá»™ng" %}
{% set description = "Táº¡o tÃ i khoáº£n má»›i trÃªn Gem.id.vn â€“ há»‡ thá»‘ng email tá»± Ä‘á»™ng, báº£o máº­t cao, chuyÃªn cho MMO vÃ  doanh nghiá»‡p." %}
{% set keywords = "Gem.id.vn, Ä‘Äƒng kÃ½ email, há»‡ thá»‘ng email tá»± Ä‘á»™ng, MMO" %}
{% set page_url = "/register" %}
{% set og_image = "/img/logo.png" %}
{% include "head-meta.njk" %}
  <body class="bg-light">
{% include "head.njk" %}

<section class="section-py bg-body landing-reviews pb-0">
  <div class="container d-flex justify-content-center align-items-center p-3">
    <div class="row">
      <div class="col-sm-12">
        <div class="card">
          <div class="card-body">
            <div class="mx-auto pt-4" style="max-width: 480px;">
              <h4 class="mb-1 text-center">ChÃ o má»«ng Ä‘áº¿n vá»›i GemID! ğŸ‘‹</h4>
              <p class="mb-6 text-center">Vui lÃ²ng Ä‘Äƒng kÃ½ Ä‘á»ƒ tiáº¿p tá»¥c.</p>

              <form id="formAuthentication" class="mb-6" autocomplete="off">
                <!-- TÃªn Ä‘Äƒng nháº­p -->
                <div class="mb-6">
                  <label for="username" class="form-label">TÃªn Ä‘Äƒng nháº­p</label>
                  <input type="text" class="form-control"
                         id="username" name="username"
                         minlength="6" maxlength="30"
                         pattern="^[a-z0-9_.]{6,30}$"
                         placeholder="TÃªn Ä‘Äƒng nháº­p (a-z, 0-9, _ .)" required>
                  <div class="invalid-feedback" id="error-username"></div>
                </div>
                <!-- Há» vÃ  tÃªn -->
                <div class="mb-6">
                  <label for="fullname" class="form-label">Há» vÃ  tÃªn</label>
                  <input type="text" class="form-control"
                         id="fullname" name="fullname"
                         minlength="6" maxlength="50"
                         placeholder="Há» vÃ  tÃªn Ä‘áº§y Ä‘á»§" required>
                  <div class="invalid-feedback" id="error-fullname"></div>
                </div>
                <!-- Email -->
                <div class="mb-6">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control"
                         id="email" name="email"
                         maxlength="100"
                         placeholder="Nháº­p email" required>
                  <div class="invalid-feedback" id="error-email"></div>
                </div>
                <!-- Máº­t kháº©u -->
                <div class="mb-6 form-password-toggle">
                  <label for="password" class="form-label">Máº­t kháº©u</label>
                  <div class="input-group input-group-merge">
                    <input type="password" class="form-control"
                           id="password" name="password"
                           minlength="8" maxlength="30"
                           pattern="^[a-zA-Z0-9~!@#$%^&*()_+]{8,30}$"
                           placeholder="Máº­t kháº©u máº¡nh (8-30 kÃ½ tá»±)" required>
                    <span class="input-group-text cursor-pointer" onclick="togglePassword('password')">
                      <i class="ti ti-eye-off"></i>
                    </span>
                  </div>
                  <div class="invalid-feedback" id="error-password"></div>
                </div>
                <!-- Nháº­p láº¡i máº­t kháº©u -->
                <div class="mb-6 form-password-toggle">
                  <label for="confirm_password" class="form-label">Nháº­p láº¡i máº­t kháº©u</label>
                  <div class="input-group input-group-merge">
                    <input type="password" class="form-control"
                           id="confirm_password" name="confirm_password"
                           minlength="8" maxlength="30"
                           placeholder="Nháº­p láº¡i máº­t kháº©u" required>
                    <span class="input-group-text cursor-pointer" onclick="togglePassword('confirm_password')">
                      <i class="ti ti-eye-off"></i>
                    </span>
                  </div>
                  <div class="invalid-feedback" id="error-confirm-password"></div>
                </div>
                <!-- Sá»‘ Ä‘iá»‡n thoáº¡i -->
                <div class="mb-6">
                  <label for="phone" class="form-label">Sá»‘ Ä‘iá»‡n thoáº¡i</label>
                  <input type="tel" class="form-control"
                         id="phone" name="phone"
                         pattern="^[0-9]{10,15}$"
                         placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i 10-15 sá»‘" required>
                  <div class="invalid-feedback" id="error-phone"></div>
                </div>
                <!-- PIN (8 sá»‘) -->
                <div class="mb-6 form-password-toggle">
                <label for="pin" class="form-label">PIN (8 sá»‘)</label>
                <div class="input-group input-group-merge">
                <input type="password" class="form-control"
                 id="pin" name="pin"
                 pattern="^[0-9]{8}$"
                 minlength="8" maxlength="8"
                    placeholder="Nháº­p PIN 8 sá»‘" inputmode="numeric" required>
    <span class="input-group-text cursor-pointer" onclick="togglePassword('pin')">
      <i class="ti ti-eye-off"></i>
    </span>
  </div>
  <div class="invalid-feedback" id="error-pin"></div>
</div>

                <!-- Äiá»u khoáº£n -->
                <div class="mb-6 mt-8">
                  <div class="form-check mb-8 ms-2">
                    <input class="form-check-input" type="checkbox"
                           id="terms-conditions" name="terms" required>
                    <label class="form-check-label" for="terms-conditions">
                      TÃ´i Ä‘á»“ng Ã½ vá»›i <a href="/terms" target="_blank">Äiá»u khoáº£n vÃ  Ä‘iá»u kiá»‡n</a>
                    </label>
                    <div class="invalid-feedback" id="error-terms"></div>
                  </div>
                </div>
                <!-- Captcha Cloudflare Turnstile -->
                <div class="mb-6">
                  <div class="input-group mb-4 input-section w-100">
                    <div class="cf-turnstile w-100"
                         data-sitekey="0x4AAAAAABiYUvkjZoEsX0vR"
                         data-size="flexible" data-theme="light"
                         data-callback="onCaptchaSuccess"
                         data-expired-callback="onCaptchaExpired"
                         data-error-callback="onCaptchaExpired"></div>
                  </div>
                  <div class="invalid-feedback" id="error-captcha"></div>
                </div>
                <!-- NÃºt Ä‘Äƒng kÃ½ -->
                <button class="btn btn-primary d-grid w-100" id="register-btn" type="submit" disabled>
                  ÄÄƒng kÃ½
                </button>
                <div id="form-message" class="text-center mt-2"></div>
              </form>
              <p class="text-center mt-2">
                <span>Báº¡n Ä‘Ã£ cÃ³ tÃ i khoáº£n?</span>
                <a href="/login"><span>ÄÄƒng nháº­p ngay</span></a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
function togglePassword(id) {
  var input = document.getElementById(id);
  input.type = input.type === "password" ? "text" : "password";
}

// --- Captcha & Validate ---
let captchaOk = false;
function onCaptchaSuccess(token) {
  captchaOk = true;
  updateRegisterBtn();
}
function onCaptchaExpired() {
  captchaOk = false;
  updateRegisterBtn();
}
function updateRegisterBtn() {
  const form = document.getElementById('formAuthentication');
  let valid = true;
  if (!form.username.value.match(/^[a-z0-9_.]{6,30}$/)) valid = false;
  if (form.fullname.value.length < 6 || form.fullname.value.length > 50) valid = false;
  if (!form.email.value.match(/^[^@]+@[^@]+\.[^@]+$/)) valid = false;
  if (!form.password.value.match(/^[a-zA-Z0-9~!@#$%^&*()_+]{8,30}$/)) valid = false;
  if (form.password.value !== form.confirm_password.value) valid = false;
  if (!form.phone.value.match(/^[0-9]{10,15}$/)) valid = false;
  if (!form.pin.value.match(/^[0-9]{8}$/)) valid = false;
  if (!form["terms-conditions"].checked) valid = false;
  if (!captchaOk) valid = false;
  document.getElementById('register-btn').disabled = !valid;
}
document.getElementById('formAuthentication').addEventListener('input', updateRegisterBtn);

// --- Xá»­ lÃ½ submit AJAX ---
document.getElementById('formAuthentication').addEventListener('submit', async function(e) {
  e.preventDefault();
  document.getElementById('register-btn').disabled = true;
  document.getElementById('form-message').innerText = "Äang xá»­ lÃ½...";

  // Láº¥y token captcha
  const captchaToken = document.querySelector('.cf-turnstile input[name="cf-turnstile-response"]')?.value || "";

  const form = e.target;
  const body = {
    username: form.username.value.trim(),
    fullname: form.fullname.value.trim(),
    email: form.email.value.trim(),
    password: form.password.value,
    confirm_password: form.confirm_password.value,
    phone: form.phone.value.trim(),
    pin: form.pin.value.trim(),
    "cf-turnstile-response": captchaToken
  };

  try {
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('form-message').innerText = "ğŸ‰ ÄÄƒng kÃ½ thÃ nh cÃ´ng!";
      // CÃ³ thá»ƒ redirect sau vÃ i giÃ¢y:
      setTimeout(() => window.location.href = '/login', 2000);
    } else {
      document.getElementById('form-message').innerText = data.message || "CÃ³ lá»—i xáº£y ra, thá»­ láº¡i!";
      document.getElementById('register-btn').disabled = false;
    }
  } catch (err) {
    document.getElementById('form-message').innerText = "KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c server!";
    document.getElementById('register-btn').disabled = false;
  }
});
</script>
// HÃ m reset captcha sau má»—i submit (dÃ¹ thÃ nh cÃ´ng hay lá»—i)
function resetCaptcha() {
  // Cloudflare Turnstile sáº½ tá»± thÃªm object window.turnstile náº¿u Ä‘Ã£ load xong
  if (window.turnstile && typeof window.turnstile.reset === "function") {
    // Láº¥y ID widget Ä‘áº§u tiÃªn trÃªn trang (náº¿u nhiá»u widget, truyá»n ID cá»¥ thá»ƒ)
    const widget = document.querySelector(".cf-turnstile");
    if (widget) window.turnstile.reset(widget);
  }
}

// Äáº·t láº¡i captcha sau má»—i submit (thÃ nh cÃ´ng hoáº·c lá»—i)
document.getElementById('formAuthentication').addEventListener('submit', async function(e) {
  e.preventDefault();
  document.getElementById('register-btn').disabled = true;
  document.getElementById('form-message').innerText = "Äang xá»­ lÃ½...";

  // Láº¥y token captcha má»›i nháº¥t
  const captchaToken = document.querySelector('.cf-turnstile input[name="cf-turnstile-response"]')?.value || "";

  // ...cÃ¡c bÆ°á»›c láº¥y giÃ¡ trá»‹ form...

  try {
    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.success) {
      document.getElementById('form-message').innerText = "ğŸ‰ ÄÄƒng kÃ½ thÃ nh cÃ´ng!";
      setTimeout(() => window.location.href = '/login', 2000);
    } else {
      document.getElementById('form-message').innerText = data.message || "CÃ³ lá»—i xáº£y ra, thá»­ láº¡i!";
      document.getElementById('register-btn').disabled = false;
      resetCaptcha(); // LuÃ´n reset captcha sau khi submit lá»—i!
    }
  } catch (err) {
    document.getElementById('form-message').innerText = "KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c server!";
    document.getElementById('register-btn').disabled = false;
    resetCaptcha(); // LuÃ´n reset captcha sau khi submit lá»—i!
  }
});

// Äáº£m báº£o captcha luÃ´n má»›i khi F5 (trang load láº¡i Turnstile auto reset, khÃ´ng cáº§n code thÃªm)
// Náº¿u muá»‘n chá»§ Ä‘á»™ng reset khi trang vá»«a load:
window.addEventListener('DOMContentLoaded', resetCaptcha);

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

{% include "footer.njk" %}
  </body>
{% include "footer-meta.njk" %}
